import React, {
  createContext,
  useContext,
  useState,
  useEffect,
  ReactNode,
} from "react";

interface ModoOscuroContextoProps {
  modoOscuro: boolean;
  alternarModoOscuro: () => void;
}

const ModoOscuroContexto = createContext<ModoOscuroContextoProps | null>(null);

interface ProveedorModoOscuroProps {
  children: ReactNode;
}

export const ProveedorModoOscuro: React.FC<ProveedorModoOscuroProps> = ({
  children,
}) => {
  const [modoOscuro, setModoOscuro] = useState<boolean>(() => {
    try {
      const guardado = localStorage.getItem("modoOscuro");
      return guardado ? JSON.parse(guardado) : false;
    } catch {
      return false; // ðŸ”’ Seguridad ante fallos de localStorage
    }
  });

  const alternarModoOscuro = () => {
    setModoOscuro((anterior) => {
      const nuevoEstado = !anterior;
      try {
        localStorage.setItem("modoOscuro", JSON.stringify(nuevoEstado));
      } catch {
        // ðŸš« No interrumpimos la ejecuciÃ³n si falla
      }
      return nuevoEstado;
    });
  };

  useEffect(() => {
    document.body.classList.toggle("oscuro", modoOscuro); // ðŸ§¼ Mejor prÃ¡ctica para clases
  }, [modoOscuro]);

  return (
    <ModoOscuroContexto.Provider value={{ modoOscuro, alternarModoOscuro }}>
      {children}
    </ModoOscuroContexto.Provider>
  );
};

export const usarModoOscuro = (): ModoOscuroContextoProps => {
  const contexto = useContext(ModoOscuroContexto);
  if (contexto === null) {
    throw new Error(
      "usarModoOscuro debe usarse dentro de un ProveedorModoOscuro"
    );
  }
  return contexto;
};
